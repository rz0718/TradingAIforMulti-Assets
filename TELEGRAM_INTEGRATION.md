# Telegram Integration Guide

## Overview

The trading bot now sends beautifully formatted trading signals and portfolio updates directly to your Telegram chat. Each update includes:

1. **New Trades** (at the top) - All trades executed in the current iteration
2. **Current Positions** - Real-time status of all open positions
3. **Portfolio Summary** - Total equity, returns, and AI-generated insights

## Features

âœ¨ **Professional formatting** with emojis and HTML styling
ğŸ“Š **Real-time updates** sent at each trading iteration
ğŸ¯ **Clear structure** - Trades first, then positions, then summary
ğŸ’° **Detailed trade info** - Entry/exit prices, P&L, leverage, stop loss, take profit
ğŸ“ˆ **Position tracking** - Unrealized P&L with percentage changes
ğŸ¤– **AI insights** - Short summaries generated by the portfolio manager

## Setup

### 1. Create a Telegram Bot

1. Open Telegram and search for `@BotFather`
2. Send `/newbot` command
3. Follow the prompts to name your bot
4. Copy the **bot token** (format: `123456789:ABCdefGHIjklMNOpqrsTUVwxyz`)

### 2. Get Your Chat ID

**Option A: Using the bot**
1. Send a message to your bot (any message)
2. Visit: `https://api.telegram.org/bot<YOUR_BOT_TOKEN>/getUpdates`
3. Look for `"chat":{"id":123456789}` in the response
4. Copy the chat ID number

**Option B: Using @userinfobot**
1. Search for `@userinfobot` on Telegram
2. Start a chat with it
3. It will send you your chat ID

### 3. Configure Environment Variables

Add to your `.env` file:

```bash
# Telegram Bot Configuration
TELEGRAM_BOT_TOKEN=123456789:ABCdefGHIjklMNOpqrsTUVwxyz
TELEGRAM_CHAT_ID=123456789
```

## Testing

### Preview Message Format (No Sending)

```bash
python test_telegram_format.py
```

This will show you:
- Sample message with trades and positions
- Sample message with no new trades
- Sample message with no positions

### Send Test Message to Telegram

```bash
python test_telegram_format.py --send
```

This will send an actual test message to your Telegram bot so you can see how it looks on your phone.

## Message Format

### Example Output

```
ğŸ¤– Trading Bot Update ğŸ¤–
==============================

ğŸ“Š NEW TRADES
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸŸ¢ ENTRY BTC LONG
   ğŸ’° Price: $43250.5000
   ğŸ“¦ Quantity: 0.0500
   ğŸ¯ Target: $44500.0000
   ğŸ›¡ï¸ Stop Loss: $42800.0000
   âš¡ Leverage: 10x
   ğŸ’­ Strong bullish momentum with RSI showing oversold conditions

âœ… CLOSE ETH LONG
   ğŸ’° Price: $2280.7500
   ğŸ’š P&L: $125.50
   ğŸ’­ Take profit target reached


ğŸ“ˆ CURRENT POSITIONS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸŸ¢ BTC LONG (10x)
   ğŸ’° Entry: $43250.5000 â†’ Current: $43350.0000
   ğŸ“¦ Quantity: 0.0500
   ğŸ’š Unrealized P&L: $5.00 (+2.31%)
   ğŸ¯ Target: $44500.0000 | ğŸ›¡ï¸ Stop: $42800.0000

ğŸ”´ SOL SHORT (5x)
   ğŸ’° Entry: $98.5000 â†’ Current: $97.8000
   ğŸ’š Unrealized P&L: $7.00 (+3.55%)
   ğŸ¯ Target: $95.0000 | ğŸ›¡ï¸ Stop: $100.0000


ğŸ’¼ PORTFOLIO SUMMARY
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ’µ Total Equity: $10125.50
ğŸ“Š Total Return: +1.26%
ğŸ’¹ Unrealized P&L: $+12.00
ğŸ“ Open Positions: 2

ğŸ’­ Bullish momentum building. Portfolio up this week. ğŸš€

==============================
â° 2025-11-03 14:30:00 UTC
```

## Integration Details

### Code Structure

The integration consists of two main components:

1. **`utils.format_trading_signal_message()`** - Formats the message with HTML
2. **`utils.send_telegram_message()`** - Sends the message via Telegram API

### In Trading Workflow

The Telegram notification is sent at each trading iteration, after:
- Market data is collected
- AI decisions are made
- Trades are executed
- Portfolio summaries are generated

Location in code: `bot/trading_workflow.py` line ~673

```python
# 5. Send Telegram notification
if config.TELEGRAM_BOT_TOKEN and config.TELEGRAM_CHAT_ID:
    telegram_message = utils.format_trading_signal_message(
        new_trades=state.current_iteration_trades,
        positions=state.positions,
        market_snapshots=market_snapshots,
        short_summary=summary.get("short_summary", ""),
        total_equity=summary["total_equity"],
        total_return_pct=summary["total_return_pct"],
        net_unrealized_pnl=summary["net_unrealized_pnl"],
    )
    utils.send_telegram_message(telegram_message, parse_mode="HTML")
```

## Emoji Legend

| Emoji | Meaning |
|-------|---------|
| ğŸŸ¢ | Long position / Buy |
| ğŸ”´ | Short position / Sell |
| âœ… | Profitable close |
| âŒ | Loss close |
| ğŸ’š | Profit / Positive PnL |
| ğŸ”» | Loss / Negative PnL |
| ğŸ’° | Price information |
| ğŸ“¦ | Quantity |
| ğŸ¯ | Take profit target |
| ğŸ›¡ï¸ | Stop loss |
| âš¡ | Leverage |
| ğŸ’­ | AI reasoning / Summary |
| ğŸ“Š | Return percentage |
| ğŸ’¹ | Unrealized PnL |
| ğŸ“ | Number of positions |
| ğŸ’µ | Total equity |
| â° | Timestamp |

## Customization

### Modify Message Format

Edit `bot/utils.py` â†’ `format_trading_signal_message()` function to:
- Change emoji choices
- Adjust formatting structure
- Add/remove information fields
- Change HTML styling

### Notification Frequency

Currently sends at each trading iteration. To change:
- Modify in `bot/config.py` â†’ `CHECK_INTERVAL` (in seconds)
- Default: 180 seconds (3 minutes)

### Conditional Notifications

To only send when trades occur, wrap the Telegram call in:

```python
if state.current_iteration_trades:  # Only if trades happened
    utils.send_telegram_message(telegram_message, parse_mode="HTML")
```

## Troubleshooting

### "Failed to send message" Error

**Check:**
1. Bot token is correct
2. Chat ID is correct (should be a number)
3. You've sent at least one message to the bot first
4. Bot is not blocked

### Messages Look Plain (No Formatting)

**Solution:** Make sure you're passing `parse_mode="HTML"` parameter:
```python
utils.send_telegram_message(message, parse_mode="HTML")
```

### Messages Too Long

Telegram has a 4096 character limit. If exceeded:
- Message will fail to send
- Consider summarizing position details
- Split into multiple messages if needed

### Rate Limiting

Telegram limits bots to ~30 messages/second. This shouldn't be an issue with normal trading frequency (every 3 minutes).

## Privacy & Security

âš ï¸ **Important:**
- Never share your bot token publicly
- Add `.env` to `.gitignore` (already done)
- Your bot token gives full control of the bot
- Chat ID is not sensitive but shouldn't be shared widely

## Additional Features

### Group Notifications

To send to a Telegram group:
1. Add your bot to the group
2. Get the group chat ID (negative number like `-123456789`)
3. Use the group chat ID in your `.env` file

### Multiple Recipients

To send to multiple chats, modify `send_telegram_message()` to loop through multiple chat IDs:

```python
TELEGRAM_CHAT_IDS = ["123456789", "-987654321"]  # Your IDs

for chat_id in TELEGRAM_CHAT_IDS:
    # Send to each chat
```

## Support

For issues or questions:
1. Check this guide first
2. Review error logs in console
3. Test with `test_telegram_format.py --send`
4. Verify credentials with `@BotFather` on Telegram

